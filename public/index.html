<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Chat</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Chat body -->
  <div id="chat">
    <div id="messages"></div>
    <div id="typing"></div>
    <form id="form">
      <input id="input" placeholder="Type a message..." autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </div>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const form = document.getElementById("form");
  const input = document.getElementById("input");
  const messages = document.getElementById("messages");
  const typingDiv = document.getElementById("typing");
  let typingTimeout;

  // Prompt for username when page loads
  const username = prompt("Enter your name") || "Anonymous";

  // Save locally for later use
  localStorage.setItem("username", username);

  // Send chat messages
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    if (input.value.trim()) {
      socket.emit("chat message", { user: username, text: input.value.trim() });
      input.value = "";
    }
  });

  // Receive and display chat messages
  socket.on("chat message", (data) => {
    addMessage(data);
    if (data.user !== username) {
      socket.emit("read message", data.id);
    }
  });

  socket.on("message status", (data) => {
    const msgElem = document.getElementById(data.id);
    if (msgElem) {
      const statusSpan = msgElem.querySelector(".status");
      statusSpan.className = `status ${data.status}`;
      statusSpan.textContent = getStatusIcon(data.status);
    }
  });

  function addMessage(data) {
    const div = document.createElement("div");
    div.classList.add("msg", data.user === username ? "me" : "other");
    div.id = data.id || "";
    div.innerHTML = `<strong>${data.user}:</strong> ${data.text}
      <span class="time">${data.time}</span>
      <span class="status ${data.status || ""}">${getStatusIcon(data.status)}</span>`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function getStatusIcon(status) {
    if (status === "sent") return "✔";
    if (status === "delivered") return "✔✔";
    if (status === "read") return "✔✔";
    return "";
  }

  input.addEventListener("input", () => {
    socket.emit("typing", username);
  });

  socket.on("typing", (user) => {
    typingDiv.textContent = `${user} is typing...`;
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      typingDiv.textContent = "";
    }, 1000);
  });
</script>

</body>
</html>
